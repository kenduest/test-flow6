[{"id":"1bd17114.208f7f","type":"tab","label":"Sinopac Daily #1","disabled":false,"info":""},{"id":"7fecb27a.52195c","type":"tab","label":"Sinopac Daily #2","disabled":false,"info":""},{"id":"deec9abb.8db008","type":"tab","label":"Sinopac Daily #3","disabled":false,"info":""},{"id":"4220a3b1.e65a7c","type":"tab","label":"Sinopac to Report","disabled":false,"info":""},{"id":"35b0806c.4ac0e8","type":"MSSQL-CN","tdsVersion":"7_4","name":" Kernel MSSQL","server":"{{{KERNEL_DATABASE_HOST}}}","port":"{{{KERNEL_DATABASE_PORT}}}","encyption":true,"trustServerCertificate":true,"database":"{{{KERNEL_DATABASE_DB}}}","useUTC":true,"connectTimeout":"15000","requestTimeout":"15000","cancelTimeout":"5000","pool":"5","parseJSON":false,"enableArithAbort":true},{"id":"1120185.4a64de8","type":"MSSQL-CN","tdsVersion":"7_4","name":"Sinopac Kernel DB","server":"10.11.144.120","port":"1433","encyption":true,"trustServerCertificate":true,"database":"NBPKernel","useUTC":false,"connectTimeout":"15000","requestTimeout":"15000","cancelTimeout":"5000","pool":"5","parseJSON":false,"enableArithAbort":true},{"id":"9610aff8.a70458","type":"redis-config","name":"redis-cluster:6379","options":"redis://redis-cluster:6379","cluster":false,"optionsType":"str"},{"id":"61aba7a0.76488","type":"MSSQL-CN","tdsVersion":"7_4","name":"Report DB","server":"{{{REPORT_DATABASE_HOST}}}","port":"{{{REPORT_DATABASE_PORT}}}","encyption":true,"trustServerCertificate":true,"database":"{{{REPORT_DATABASE_DB}}}","useUTC":true,"connectTimeout":"15000","requestTimeout":"15000","cancelTimeout":"5000","pool":"5","parseJSON":false,"enableArithAbort":true},{"id":"206a78b0.d9321","type":"switch","z":"1bd17114.208f7f","name":"Check API Response","property":"statusCode","propertyType":"msg","rules":[{"t":"eq","v":"200","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":2240,"y":1880,"wires":[["5a1d672a.d52e78"],["6e5d7fdc.09a498"]]},{"id":"5e858370.4b4a54","type":"switch","z":"1bd17114.208f7f","name":"","property":"have_error","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":3630,"y":1900,"wires":[["b3769017.156f6"],[]]},{"id":"b3769017.156f6","type":"delay","z":"1bd17114.208f7f","name":"","pauseType":"delay","timeout":"2","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":3140,"y":2020,"wires":[["eacfb53c.9c8eb"]]},{"id":"c5bf226.1745ae","type":"function","z":"1bd17114.208f7f","name":"Log Write Report DB","func":"\nmsg.have_error = 0\n    \nif ( (typeof msg.error == 'undefined') || (msg.error == null) )  {\n    msg.result = \"[GRAVITY][ATOMIC] Write SMS Delivery Log to Report DB Success\"\n    code = 0\n    level = 'INFO'\n\n    msg.payload = {\n        \"channel\": \"GRAVITY_SMS_MESSAGE_API\",\n        \"level\": level,\n        \"code\": code,\n        \"msg\": msg.result,\n        \"time\": (new Date()).toJSON(),\n        \"payload\": { \n            \"DeliveryPoolUID\": msg.DeliveryPoolUID,\n            \"SendUID\": msg.SendUID,\n            \"SendRecordUID\": msg.SendRecordUID,\n        }\n   }\n\n    \n} else {\n    msg.result = \"[GRAVITY][ATOMIC] Write SMS Delivery Log to Report DB Failure\"\n    msg.have_error = 1\n    level = 'ERROR'\n    code = 5304\n\n    msg.payload = {\n        \"channel\": \"GRAVITY_SMS_MESSAGE_API\",\n        \"level\": level,\n        \"code\": code,\n        \"msg\": msg.result,\n        \"time\": (new Date()).toJSON(),\n        \"payload\": { \n            \"DeliveryPoolUID\": msg.DeliveryPoolUID,\n            \"SendUID\": msg.SendUID,\n            \"SendRecordUID\": msg.SendRecordUID,\n            \"error\": msg.error\n        }\n   }\n    \n}\n\n\n\nreturn msg\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":3400,"y":1800,"wires":[["7cb9964c.de27e8","5e858370.4b4a54","65d34139.3de0c8","9ebd2a20.bf725"]]},{"id":"df7383cb.9cd5f","type":"MSSQL","z":"1bd17114.208f7f","mssqlCN":"35b0806c.4ac0e8","name":"MSSQL Report","outField":"payload","returnType":0,"throwErrors":"0","query":"INSERT INTO [dbo].[DeliveryResultLog](DeliveryPoolUID, DeliverySendUID, DeliverySendRecordUID, Status, Message, SourceType) VALUES(@DeliveryPoolUID, @DeliverySendUID, @DeliverySendRecordUID, @ResponseStatus, @ResponseMessage, 'Realtime')\n","modeOpt":"","modeOptType":"query","queryOpt":"","queryOptType":"editor","paramsOpt":"","paramsOptType":"editor","rows":"rows","rowsType":"msg","params":[{"output":false,"name":"DeliveryPoolUID","type":"VarChar(?)","valueType":"msg","value":"DeliveryPoolUID","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"DeliverySendUID","type":"VarChar(?)","valueType":"msg","value":"SendUID","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"DeliverySendRecordUID","type":"VarChar(?)","valueType":"msg","value":"SendRecordUID","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"ResponseMessage","type":"NVarChar(?)","valueType":"msg","value":"ResponseMessage","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"ResponseStatus","type":"int","valueType":"msg","value":"ResponseStatus","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}}],"x":3120,"y":1860,"wires":[["c5bf226.1745ae"]]},{"id":"eacfb53c.9c8eb","type":"loop","z":"1bd17114.208f7f","name":"","kind":"fcnt","count":"3","initial":"1","step":"1","condition":"","conditionType":"js","when":"before","enumeration":"enum","enumerationType":"msg","limit":"20000","loopPayload":"loop-orig","finalPayload":"final-last","x":2870,"y":1860,"wires":[[],["df7383cb.9cd5f"]]},{"id":"d38c299d.762cf","type":"debug","z":"1bd17114.208f7f","name":"Display sendUID","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"sendUID","targetType":"msg","statusVal":"","statusType":"auto","x":2910,"y":1700,"wires":[]},{"id":"28dfc911.f39766","type":"debug","z":"1bd17114.208f7f","name":"Display DeliveryUID","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"deliveryUID","targetType":"msg","statusVal":"","statusType":"auto","x":2920,"y":1740,"wires":[]},{"id":"5a1d672a.d52e78","type":"function","z":"1bd17114.208f7f","name":"Log HTTP Response","func":"\nmsg.ResponseMessage = msg.payload\nmsg.ResponseStatus = 0\nmsg.SendUID = JSON.parse(msg.payload)[\"sendUid\"]\n\nmsg.SendRecordUID = JSON.parse(msg.payload)[\"results\"][0][\"sendRecordUid\"] || null\n\nmsg.result = \"[GRAVITY][ATOMIC] HTTP Post via Message API success\"\n\nmsg.payload = {\n    \"channel\": \"GRAVITY_SMS_MESSAGE_API\",\n    \"level\": \"INFO\",\n    \"code\": 0,\n    \"msg\": msg.result,\n    \"time\": (new Date()).toJSON(),\n    \"payload\": {\n        \"DeliveryPoolUID\": msg.DeliveryPoolUID,\n        \"SendUID\": msg.SendUID,\n        \"SendRecordUID\": msg.SendRecordUID\n    }\n}\n\nreturn msg\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2520,"y":1860,"wires":[["d38c299d.762cf","28dfc911.f39766","eacfb53c.9c8eb","2c9233fb.fd9efc","9b98c796.aa0568"]]},{"id":"7cb9964c.de27e8","type":"debug","z":"1bd17114.208f7f","name":"Display Result","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":3740,"y":1800,"wires":[]},{"id":"6e5d7fdc.09a498","type":"function","z":"1bd17114.208f7f","name":"Log HTTP Response","func":"\nmsg.result = \"[GRAVITY][ATOMIC] HTTP via Message API failure\"\nmsg.ResponseMessage = msg.payload\nmsg.ResponseStatus = 5303\n\nmsg.payload = {\n    \"channel\": \"GRAVITY_MESSAGE_API\",\n    \"level\": \"ERROR\",\n    \"code\": msg.ResponseStatus,\n    \"message\": msg.result,\n    \"time\": (new Date()).toJSON(),\n    \"payload\": {\n        \"DeliveryPoolUID\": msg.DeliveryPoolUID,\n        \"error\": msg.ResponseMessage\n    }\n}\n\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2540,"y":2220,"wires":[["6c6fe2cb.c86474","2b0af9e9.d913de","d5432e70.044a78"]]},{"id":"b857c00f.8f4b58","type":"switch","z":"1bd17114.208f7f","name":"","property":"have_error","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":3070,"y":2660,"wires":[["efb42dca.7e907"]]},{"id":"efb42dca.7e907","type":"delay","z":"1bd17114.208f7f","name":"","pauseType":"delay","timeout":"2","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":2840,"y":2760,"wires":[["2b0af9e9.d913de"]]},{"id":"3f338f22.4d30d","type":"function","z":"1bd17114.208f7f","name":"Log Write Report DB","func":"\n    \nif ( (typeof msg.error == 'undefined') || (msg.error == null) )  {\n    msg.result = \"[GRAVITY][ATOMIC] Write SMS Delivery Log to Report DB Success\"\n    msg.have_error = 0\n    code = 0\n    level = \"INFO\"\n\n    \n} else {\n    msg.result = \"[GRAVITY][ATOMIC] Write SMS Delivery Log to Report DB Failure\"\n    msg.have_error = 1\n    code = 5304\n    level = \"ERROR\"\n}\n\nmsg.payload = {\n    \"channel\": \"GRAVITY_SMS_MESSAGE_API\",\n    \"level\": level,\n    \"code\": code,\n    \"msg\": msg.result,\n    \"time\": (new Date()).toJSON(),\n    \"payload\": { \n        \"DeliveryPoolUID\": msg.DeliveryPoolUID,\n        \"error\": msg.error\n    }\n}\n\n\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":3260,"y":2520,"wires":[["4e824f07.5e5c38","b857c00f.8f4b58","cb29d8eb.5857d","85259d79.f1d17"]]},{"id":"b846afcd.53a52","type":"MSSQL","z":"1bd17114.208f7f","mssqlCN":"35b0806c.4ac0e8","name":"MSSQL Report","outField":"payload","returnType":0,"throwErrors":"0","query":"INSERT INTO [dbo].[DeliveryResultLog](DeliveryPoolUID, Status, Message, SourceType) VALUES(@DeliveryPoolUID, @ResponseStatus, @ResponseMessage, 'Realtime')\n","modeOpt":"","modeOptType":"query","queryOpt":"","queryOptType":"editor","paramsOpt":"","paramsOptType":"editor","rows":"rows","rowsType":"msg","params":[{"output":false,"name":"DeliveryPoolUID","type":"UniqueIdentifier","valueType":"msg","value":"DeliveryPoolUID","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"ResponseMessage","type":"NVarChar(?)","valueType":"msg","value":"ResponseMessage","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"ResponseStatus","type":"int","valueType":"msg","value":"ResponseStatus","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}}],"x":3040,"y":2520,"wires":[["3f338f22.4d30d"]]},{"id":"2b0af9e9.d913de","type":"loop","z":"1bd17114.208f7f","name":"","kind":"fcnt","count":"3","initial":"1","step":"1","condition":"","conditionType":"js","when":"before","enumeration":"enum","enumerationType":"msg","limit":"20000","loopPayload":"loop-orig","finalPayload":"final-last","x":2790,"y":2520,"wires":[[],["b846afcd.53a52"]]},{"id":"4e824f07.5e5c38","type":"debug","z":"1bd17114.208f7f","name":"Display Result","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":3500,"y":2520,"wires":[]},{"id":"6c6fe2cb.c86474","type":"debug","z":"1bd17114.208f7f","name":"Display Result","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"result","targetType":"msg","statusVal":"","statusType":"auto","x":2860,"y":2320,"wires":[]},{"id":"d5432e70.044a78","type":"redis-out","z":"1bd17114.208f7f","server":"9610aff8.a70458","command":"publish","name":"","topic":"GRAVITY_SMS_MESSAGE_API","obj":true,"x":2890,"y":2220,"wires":[]},{"id":"cb29d8eb.5857d","type":"redis-out","z":"1bd17114.208f7f","server":"9610aff8.a70458","command":"publish","name":"","topic":"GRAVITY_SMS_MESSAGE_API","obj":true,"x":3570,"y":2380,"wires":[]},{"id":"9ebd2a20.bf725","type":"redis-out","z":"1bd17114.208f7f","server":"9610aff8.a70458","command":"publish","name":"","topic":"GRAVITY_SMS_MESSAGE_API","obj":true,"x":3730,"y":1680,"wires":[]},{"id":"2c9233fb.fd9efc","type":"redis-out","z":"1bd17114.208f7f","server":"9610aff8.a70458","command":"publish","name":"","topic":"GRAVITY_SMS_MESSAGE_API","obj":true,"x":2930,"y":1640,"wires":[]},{"id":"acd077a.4edb588","type":"redis-in","z":"1bd17114.208f7f","d":true,"server":"9610aff8.a70458","command":"subscribe","name":"Query Redis","topic":"GRAVITY_SMS_MESSAGE_API","obj":true,"timeout":"3","x":150,"y":1520,"wires":[["dec0b9f9.fe26d"]]},{"id":"dec0b9f9.fe26d","type":"debug","z":"1bd17114.208f7f","name":"Display Redis Result","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":360,"y":1580,"wires":[]},{"id":"85259d79.f1d17","type":"nats-streaming-acknowledge","z":"1bd17114.208f7f","name":"ACK","x":3490,"y":2460,"wires":[]},{"id":"65d34139.3de0c8","type":"nats-streaming-acknowledge","z":"1bd17114.208f7f","name":"ACK","x":3730,"y":1740,"wires":[]},{"id":"9b98c796.aa0568","type":"debug","z":"1bd17114.208f7f","name":"Display Result","active":false,"tosidebar":true,"console":true,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":2900,"y":1780,"wires":[]},{"id":"d1568633.e97428","type":"http in","z":"1bd17114.208f7f","name":"GET /action/sync/ADW","url":"/action/sync/ADW","method":"get","upload":false,"swaggerDoc":"","x":580,"y":300,"wires":[["83447e62.ec1f3"]]},{"id":"d5f5234b.f113e8","type":"inject","z":"1bd17114.208f7f","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":610,"y":240,"wires":[["83447e62.ec1f3"]]},{"id":"91939044.bbb908","type":"debug","z":"1bd17114.208f7f","name":"Display Result","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":1320,"y":220,"wires":[]},{"id":"65a2c3c7.f83c24","type":"http response","z":"1bd17114.208f7f","name":"","statusCode":"","headers":{},"x":1510,"y":280,"wires":[]},{"id":"d7eb21b.cf01ce","type":"function","z":"1bd17114.208f7f","name":"","func":"\nif ( (typeof msg.error == 'undefined') || (typeof msg.error != 'object') || (msg.error == null) )  {\n\n    msg.have_error = 0\n\n    msg.result = \"[GRAVITY][ATOMIC] Update ADB DB Success\"\n\n    msg.payload = {\n        \"channel\": \"GRAVITY_SMS_KERNEL_DB\",\n        \"level\": \"INFO\",\n        \"code\": 0,\n        \"message\": msg.result,\n        \"timestamp\": (new Date()).toJSON()\n        }\n}\n\nelse {\n    msg.result = \"[GRAVITY][ATOMIC] Update ADB DB Failure\"\n    msg.have_error = 1\n\n    msg.payload = {\n        \"channel\": \"GRAVITY_SMS_KERNEL_DB\",\n        \"level\": \"ERROR\",\n        \"code\": 5304,\n        \"message\": msg.result,\n        \"timestamp\": (new Date()).toJSON()\n        }\n}\n\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1370,"y":300,"wires":[["65a2c3c7.f83c24"]]},{"id":"289350d5.3b4858","type":"cronplus","z":"1bd17114.208f7f","name":"Crontab","outputField":"payload","timeZone":"","persistDynamic":false,"commandResponseMsgOutput":"output1","outputs":1,"options":[{"name":"schedule1","topic":"topic1","payloadType":"default","payload":"","expressionType":"cron","expression":"0 0 5 * * * *","location":"","offset":"0","solarType":"all","solarEvents":"sunrise,sunset"}],"x":580,"y":580,"wires":[["2f2f3456.411b74"]]},{"id":"45079bc0.2cd8d4","type":"MSSQL","z":"1bd17114.208f7f","mssqlCN":"35b0806c.4ac0e8","name":"MSSQL Kernel","outField":"payload","returnType":0,"throwErrors":"0","query":"\n\nBEGIN TRANSACTION;  \n\n-- Delete\n\nDELETE from {{{settings.adw_table_name}}} \nWHERE recordid IN (\n    SELECT substring(upper(send_record.uid), 1, 20) \n    FROM   {{{settings.send_record_table_name}}} as send_record\n    WHERE  cast(send_record.create_time AS date) = dateadd(day, -1, cast(getdate() AS date))\n)\n\n-- -- Insert\n\nINSERT INTO {{{settings.adw_table_name}}} \n            ( \n                        deliverytype, \n                        channel, \n                        pgcode, \n                        pgdesc, \n                        batchno, \n                        recordid, \n                        psendtime, \n                        rsendtime, \n                        checkflag, \n                        errormsg, \n                        sendflag, \n                        sendstatus, \n                        isread, \n                        custid, \n                        custphonenum , \n                        outsysid, \n                        msgcontenttype, \n                        priority, \n                        msgcontent \n            ) \nSELECT '4'                                                                            AS deliverytype,\n      send.req_channel                                                               AS channel, \n      send.msg_type                                                                  AS pgcode, \n      CONVERT(varchar(100), send_record.gateway_id)                                  AS pgdesc, \n      iif(send.req_batch_id IS NULL, '', substring(upper(send.req_batch_id), 1, 20)) AS batchno, \n      substring(upper(send_record.uid), 1, 20)                                       AS recordid, \n      cast(send_record.send_time AS        datetime)                                        AS psendtime,\n      cast(send_record.actual_send_time AS datetime)                                        AS rsendtime,\n      ''                                                                                    AS checkflag,\n      ''                                                                                    AS errormsg,\n      1                                                                                     AS sendflag,\n      iif(send_record.resp_code IS NULL, '', send_record.resp_code)                         AS sendstatus,\n      0                                                                                     AS isread,\n      substring(send_record.customer_id, 1, 11)                                             AS custid,\n      send_record.customer_phone                                                            AS custphonenum,\n      iif(send.req_channel LIKE '%card%', 'CARDSMS', 'BANKSMS')                             AS outsysid,\n      CASE \n              WHEN send.priority >= 9 THEN 'T' \n              WHEN send.priority <= 8 AND send.priority >= 6 THEN 'G' \n              WHEN send.priority < 5 THEN 'C' \n      END                                  AS msgcontenttype, \n      send.priority                        AS priority, \n      send_record.content                  AS msgcontent \nFROM   {{{settings.send_table_name}}}        AS send, \n      {{{settings.send_record_table_name}}} AS send_record \nWHERE  send_record.send_uid = send.uid \nAND    cast(send_record.create_time AS date) = dateadd(day, -1, cast(getdate() AS date))\n\n\n-- Update\n\nUPDATE {{{settings.adw_table_name}}}\nSET    sendflag=iif(send_record.resp_code IS NULL, '', send_record.resp_code)\nFROM   {{{settings.send_record_table_name}}} as send_record, {{{settings.send_table_name}}} as send, {{{settings.adw_table_name}}} as adw\nWHERE  send_record.send_uid = send.uid\nAND    substring(upper(send_record.uid), 1, 20) = adw.recordid\nAND    adw.sendflag != send_record.resp_code\nAND    send_record.create_time != send_record.update_time\nAND    cast(send_record.create_time AS date) >= dateadd(day, -3, cast(getdate() AS date))\n\n\nCOMMIT;  \n\n","modeOpt":"","modeOptType":"query","queryOpt":"","queryOptType":"editor","paramsOpt":"","paramsOptType":"editor","rows":"rows","rowsType":"msg","params":[],"x":1220,"y":500,"wires":[["e82fa5a.9c179d8"]]},{"id":"bb0aac95.1b7c3","type":"inject","z":"1bd17114.208f7f","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":630,"y":440,"wires":[["3744bf4c.9b687"]]},{"id":"3744bf4c.9b687","type":"function","z":"1bd17114.208f7f","name":"","func":"msg.settings = {}\n\nmsg.settings.adw_table_name = env.get(\"ADW_TABLE\") || \"[NBPReport].[dbo].[ADW_ResultLog]\"\n\nmsg.settings.send_table_name = env.get(\"SEND_TABLE\") || \"[NBPKernel].[dbo].[send]\"\n\nmsg.settings.send_record_table_name = env.get(\"SEND_RECORD_TABLE\") || \"[NBPKernel].[dbo].[send_record]\"\n\n\nreturn msg","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":930,"y":500,"wires":[["45079bc0.2cd8d4"]]},{"id":"e82fa5a.9c179d8","type":"function","z":"1bd17114.208f7f","name":"Check Result","func":"\nif ( (typeof msg.error == 'undefined') || (msg.error == null) )  {\n\n    msg.have_error = 0\n    msg.result = \"[GRAVITY][ATOMIC] Sync to ADW Database Success\"\n\n    msg.payload = {\n        \"level\": \"INFO\",\n        \"code\": 0,\n        \"message\": msg.result,\n        \"channel\": \"GRAVITY_KERNEL_SINOPAC\",\n        \"timestamp\": (new Date()).toJSON() \n        \n    }\n    \n} \n\nelse {\n    msg.result = \"[GRAVITY][ATOMIC]Sync to ADW Database Failure\"\n    msg.have_error = 1\n    \n    msg.payload = {\n        \"code\": 5304,\n        \"message\": msg.result,\n        \"channel\": \"GRAVITY_KERNEL_SINOPAC\",\n        \"level\": \"ERROR\",\n        \"timestamp\": (new Date()).toJSON(),\n        \"payload\": {\n            \"error\": msg.error\n        }\n    }\n}\n\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1420,"y":500,"wires":[["efb807e1.934de8"]]},{"id":"efb807e1.934de8","type":"debug","z":"1bd17114.208f7f","name":"Display ADW Result","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":1640,"y":500,"wires":[]},{"id":"83447e62.ec1f3","type":"function","z":"1bd17114.208f7f","name":"","func":"msg.settings = {}\n\nmsg.settings.adw_table_name = env.get(\"ADW_TABLE\") || \"[NBPReport].[dbo].[ADW_ResultLog]\"\n\nmsg.settings.send_table_name = env.get(\"SEND_TABLE\") || \"[NBPKernel].[dbo].[send]\"\n\nmsg.settings.send_record_table_name = env.get(\"SEND_RECORD_TABLE\") || \"[NBPKernel].[dbo].[send_record]\"\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":850,"y":300,"wires":[["a4686f76.2b462"]]},{"id":"a4686f76.2b462","type":"MSSQL","z":"1bd17114.208f7f","mssqlCN":"35b0806c.4ac0e8","name":"MSSQL Kernel","outField":"payload","returnType":0,"throwErrors":"0","query":"SELECT '4'                                                                            AS deliverytype,\n       send.req_channel                                                               AS channel, \n       send.msg_type                                                                  AS pgcode, \n       CONVERT(varchar(100), send_record.gateway_id)                                  AS pgdesc, \n       iif(send.req_batch_id IS NULL, '', substring(upper(send.req_batch_id), 1, 20)) AS batchno, \n       substring(upper(send_record.uid), 1, 20)                                       AS recordid, \n       cast(send_record.send_time AS        datetime)                                        AS psendtime,\n       cast(send_record.actual_send_time AS datetime)                                        AS rsendtime,\n       ''                                                                                    AS checkflag,\n       ''                                                                                    AS errormsg,\n       1                                                                                     AS sendflag,\n       iif(send_record.resp_code IS NULL, '', send_record.resp_code)                         AS sendstatus,\n       0                                                                                     AS isread,\n       substring(send_record.customer_id, 1, 11)                                             AS custid,\n       send_record.customer_phone                                                            AS custphonenum,\n       iif(send.req_channel LIKE '%card%', 'CARDSMS', 'BANKSMS')                             AS outsysid,\n       CASE \n              WHEN send.priority >= 9 THEN 'T' \n              WHEN send.priority <= 8 \n              AND    send.priority >= 6 THEN 'G' \n              WHEN send.priority < 5 THEN 'C' \n       END                                  AS msgcontenttype, \n       send.priority                        AS priority, \n       send_record.content                  AS msgcontent \nFROM   {{{settings.send_table_name}}}        AS send, \n       {{{settings.send_record_table_name}}} AS send_record \nWHERE  send_record.send_uid = send.uid \nAND    cast(send_record.create_time AS date) = dateadd(day, -1, cast(getdate() AS date))\n","modeOpt":"","modeOptType":"query","queryOpt":"","queryOptType":"editor","paramsOpt":"","paramsOptType":"editor","rows":"rows","rowsType":"msg","params":[],"x":1040,"y":300,"wires":[["91939044.bbb908","d7eb21b.cf01ce"]]},{"id":"f35f8bf7.e692b8","type":"http in","z":"1bd17114.208f7f","name":"POST /action/sync/ADW","url":"/action/sync/ADW","method":"post","upload":false,"swaggerDoc":"","x":590,"y":500,"wires":[["3744bf4c.9b687"]]},{"id":"2f2f3456.411b74","type":"switch","z":"1bd17114.208f7f","name":"Check Enabled","property":"ADW_SYNC_DAILY_ENABLED","propertyType":"env","rules":[{"t":"eq","v":"1","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":780,"y":580,"wires":[["3744bf4c.9b687"],[]]},{"id":"31795ce.9f9c324","type":"MSSQL","z":"7fecb27a.52195c","mssqlCN":"35b0806c.4ac0e8","name":"MSSQL Kernel","outField":"payload","returnType":0,"throwErrors":"0","query":"\nSELECT user_id                                     AS userid,\n       'NBP'                                       AS appid,\n       1                                           AS logaction,\n       'S'                                         AS logresult,\n       Cast(log_operation.create_time AS DATETIME) AS logdatetime,\n       '0.0.0.0'                                   AS hostip,\n       log_operation.client_ip                     AS clientip,\n       'signin'                                    AS remark\nFROM   {{{settings.log_operation_table_name}}}     as log_operation\n-- WHERE  log_operation.category = 'signin' and CAST(send_record.create_time AS date) = DATEADD(day, -1, CAST(GETDATE() AS date))\nWHERE  log_operation.category = 'signin'\n\n","modeOpt":"","modeOptType":"query","queryOpt":"","queryOptType":"editor","paramsOpt":"","paramsOptType":"editor","rows":"rows","rowsType":"msg","params":[],"x":880,"y":340,"wires":[["9eb00722.721528","1fe28317.e33e85"]]},{"id":"db518884.922c08","type":"http in","z":"7fecb27a.52195c","name":"GET /action/sync/SSO_APLoginLog","url":"/action/sync/SSO_APLoginLog","method":"get","upload":false,"swaggerDoc":"","x":380,"y":340,"wires":[["98d3c54f.ca1a6"]]},{"id":"304ab1c7.17c96e","type":"inject","z":"7fecb27a.52195c","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":450,"y":280,"wires":[["98d3c54f.ca1a6"]]},{"id":"9eb00722.721528","type":"http response","z":"7fecb27a.52195c","name":"HTTP Response","statusCode":"","headers":{},"x":1120,"y":360,"wires":[]},{"id":"76b44191.20a068","type":"MSSQL","z":"7fecb27a.52195c","mssqlCN":"35b0806c.4ac0e8","name":"MSSQL Kernel","outField":"payload","returnType":0,"throwErrors":"0","query":"\n-- Delete   \n\nDELETE FROM {{{settings.sso_aploginlog_table_name}}} \nWHERE  appid = 'NBP' \n       AND Cast(logdatetime AS DATE) = Dateadd(day, -1, Cast(Getdate() AS DATE)) \n\n-- Insert   \nINSERT INTO {{{settings.sso_aploginlog_table_name}}} \n            (userid, \n             appid, \n             logaction, \n             logresult, \n             logdatetime, \n             hostip, \n             clientip, \n             remark) \nSELECT log_operation.user_id                       AS userid, \n       'NBP'                                       AS appid, \n       1                                           AS logaction, \n       'S'                                         AS logresult, \n       Cast(log_operation.create_time AS DATETIME) AS logdatetime, \n       '0.0.0.0'                                   AS hostip, \n       log_operation.client_ip                     AS clientip, \n       'signin'                                    AS remark \nFROM   {{{settings.log_operation_table_name}}} AS log_operation \nWHERE  log_operation.category = 'signin' \n       AND Cast(log_operation.create_time AS DATE) = Dateadd(day, -1, Cast( \n                                                     Getdate() AS DATE)) \n\n--- Dalete Count \n\nDELETE FROM {{{settings.sso_aplogcontrol_table_name}}} \nWHERE Cast(ControlDate AS DATE) = Dateadd(day, -1, Cast(Getdate() AS DATE)) \n\n--- Update Count \n\n\nDECLARE @TotalCount INT \n\nSELECT @TotalCount=Count(*) \nFROM {{{settings.sso_aploginlog_table_name}}} AS sso_aploginlog \nWHERE  Cast(sso_aploginlog.LogDateTime AS DATE) = Dateadd(day, -1, Cast(Getdate() AS DATE)) \n\nINSERT INTO {{{settings.sso_aplogcontrol_table_name}}} \n            (AppID, \n             ControlDate, \n             DataCount) \nVALUES      ( 'NBP', \n              Dateadd(day, -1, Cast(Getdate() AS DATE)), \n              Cast(@TotalCount AS DECIMAL(18, 0)) ) ","modeOpt":"","modeOptType":"query","queryOpt":"","queryOptType":"editor","paramsOpt":"","paramsOptType":"editor","rows":"rows","rowsType":"msg","params":[],"x":860,"y":600,"wires":[["d929e47f.83bbe8","c9e0ce4d.64dee8"]]},{"id":"63f19825.b07d98","type":"http in","z":"7fecb27a.52195c","name":"POST /action/sync/SSO_APLoginLog","url":"/action/sync/SSO_APLoginLog","method":"post","upload":false,"swaggerDoc":"","x":370,"y":600,"wires":[["96ac7877.cd379"]]},{"id":"f596ce8b.d0ace","type":"inject","z":"7fecb27a.52195c","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":430,"y":540,"wires":[["96ac7877.cd379"]]},{"id":"d929e47f.83bbe8","type":"http response","z":"7fecb27a.52195c","name":"HTTP Response","statusCode":"","headers":{},"x":1140,"y":660,"wires":[]},{"id":"96ac7877.cd379","type":"function","z":"7fecb27a.52195c","name":"Apply Settings","func":"msg.settings = {}\n\nmsg.settings.log_operation_table_name = env.get(\"ADW_TABLE\") || \"[NBPKernel].[dbo].[log_operation]\"\nmsg.settings.sso_aploginlog_table_name = env.get(\"SSO_APLOGINLOG_TABLE\") || \"[NBPReport].[dbo].[SSO_APLoginLog]\"\nmsg.settings.sso_aplogcontrol_table_name = env.get(\"SSO_APLOGLOGCONTROL_TABLE\") || \"[NBPReport].[dbo].[SSO_APLogControl]\"\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":660,"y":600,"wires":[["76b44191.20a068"]]},{"id":"fcfd9bd9.4be6f","type":"cronplus","z":"7fecb27a.52195c","name":"Crontab","outputField":"payload","timeZone":"","persistDynamic":false,"commandResponseMsgOutput":"output1","outputs":1,"options":[{"name":"schedule1","topic":"topic1","payloadType":"default","payload":"","expressionType":"cron","expression":"0 10 5 * * * *","location":"","offset":"0","solarType":"all","solarEvents":"sunrise,sunset"}],"x":300,"y":680,"wires":[["d44a9f99.158868"]]},{"id":"d44a9f99.158868","type":"switch","z":"7fecb27a.52195c","name":"Check Enabled","property":"APLOGINLOG_SYNC_DAILY_ENABLED","propertyType":"env","rules":[{"t":"eq","v":"1","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":480,"y":680,"wires":[["96ac7877.cd379"],[]]},{"id":"98d3c54f.ca1a6","type":"function","z":"7fecb27a.52195c","name":"","func":"msg.settings = {}\n\nmsg.settings.log_operation_table_name = env.get(\"LOG_OPERATION_TABLE\") || \"[NBPKernel].[dbo].[log_operation]\"\n\nmsg.settings.sso_aploginlog_table_name = env.get(\"SSO_APLOGINLOG_TABLE\") || \"[NBPReport].[dbo].[SSO_APLoginLog]\"\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":650,"y":340,"wires":[["31795ce.9f9c324"]]},{"id":"1fe28317.e33e85","type":"debug","z":"7fecb27a.52195c","name":"Display APLoginLog Result","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":1160,"y":260,"wires":[]},{"id":"c9e0ce4d.64dee8","type":"function","z":"7fecb27a.52195c","name":"Check Result","func":"\nif ( (typeof msg.error == 'undefined') || (msg.error == null) )  {\n\n    msg.have_error = 0\n    msg.result = \"[GRAVITY][ATOMIC] Sync to SSO_APLoginLog Database Success\"\n\n    msg.payload = {\n        \"level\": \"INFO\",\n        \"code\": 0,\n        \"message\": msg.result,\n        \"channel\": \"GRAVITY_KERNEL_SINOPAC\",\n        \"timestamp\": (new Date()).toJSON() \n        \n    }\n    \n} \n\nelse {\n    msg.result = \"[GRAVITY][ATOMIC]Sync to SSO_APLoginLog Database Failure\"\n    msg.have_error = 1\n    \n    msg.payload = {\n        \"code\": 5304,\n        \"message\": msg.result,\n        \"channel\": \"GRAVITY_KERNEL_SINOPAC\",\n        \"level\": \"ERROR\",\n        \"timestamp\": (new Date()).toJSON(),\n        \"payload\": {\n            \"error\": msg.error\n        }\n    }\n}\n\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1100,"y":560,"wires":[["c36a0869.e7bb18"]]},{"id":"c36a0869.e7bb18","type":"debug","z":"7fecb27a.52195c","name":"Display APLoginLog Result","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":1340,"y":560,"wires":[]},{"id":"cda26c39.d66a1","type":"MSSQL","z":"deec9abb.8db008","mssqlCN":"1120185.4a64de8","name":"MSSQL Kernel","outField":"payload","returnType":0,"throwErrors":"0","query":"INSERT INTO\n\nSELECT CONVERT(VARCHAR(8), log_operation.create_time, 112) AS AppDate,\n       'NBP'                                       AS AppID,\n       (SELECT company.code\n        FROM   company\n        WHERE  log_operation.before_data IS NOT NULL\n               AND Json_value(log_operation.before_data, '$.companyUid') =\n                   company.uid)\n                                                   AS CompID,\n       (SELECT company.NAME\n        FROM   company\n        WHERE  log_operation.before_data IS NOT NULL\n               AND Json_value(log_operation.before_data, '$.companyUid') =\n                   company.uid)\n                                                   AS CompName,\n       department.code                             AS DeptID,\n       department.NAME                             AS DeptName,\n       Json_value(before_data, '$.userId')         AS EmpID,\n       Json_value(before_data, '$.name')           AS EmpName,\n       log_operation.function_name                 AS FunID,\n       ''                                          AS FunName,\n       '人工授權'                              AS GrantType,\n       log_operation.text                          AS GrantDesc,\n       1                                           AS WorkStatus,\n       '在職'                                    AS WorkStatusDesc,\n       log_operation.user_id                       AS GrantUserID,\n       log_operation.user_name                     GrantUserName,\n       ''                                          AS Remark\nFROM   log_operation,\n       department\nWHERE  category = 'permission' \n       AND action_name != 'deleted'\n       AND CAST(send_record.create_time AS date) = DATEADD(day, -1, CAST(GETDATE() AS date))\n","modeOpt":"","modeOptType":"query","queryOpt":"","queryOptType":"editor","paramsOpt":"","paramsOptType":"editor","rows":"rows","rowsType":"msg","params":[],"x":760,"y":520,"wires":[["218a504e.5547f"]]},{"id":"5c1ee391.cbd5ec","type":"http in","z":"deec9abb.8db008","name":"POST /action/sync/TS_SSOACInfo","url":"/action/sync/TS_SSOACInfo","method":"post","upload":false,"swaggerDoc":"","x":280,"y":520,"wires":[["2feb0278.35a91e"]]},{"id":"95e52b7b.235678","type":"inject","z":"deec9abb.8db008","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":330,"y":440,"wires":[["2feb0278.35a91e"]]},{"id":"74c0be11.330a1","type":"MSSQL","z":"deec9abb.8db008","mssqlCN":"35b0806c.4ac0e8","name":"MSSQL Kernel","outField":"payload","returnType":0,"throwErrors":"0","query":"SELECT CONVERT(VARCHAR(8), log_operation.create_time, 112) AS APPDate,\n       'NBP'                                               AS APPID,\n       (\n              SELECT company.code\n              FROM   company\n              WHERE  log_operation.before_data IS NOT NULL\n              AND    Json_value(log_operation.before_data, '$.companyUid') = company.uid ) AS compid,\n       (\n              SELECT company.NAME\n              FROM   company\n              WHERE  log_operation.before_data IS NOT NULL\n              AND    Json_value(log_operation.before_data, '$.companyUid') = company.uid ) AS compname,\n       department.code                                                                     AS deptid,\n       department.NAME                                                                     AS deptname,\n       Json_value(before_data, '$.userId')                                                 AS empid,\n       Json_value(before_data, '$.name')                                                   AS empname,\n       log_operation.function_name                                                         AS funid,\n       ''                                                                                  AS funname,\n       '人工授權'                                                                          AS granttype,\n       log_operation.text                                                                  AS grantdesc,\n       1                                                                                   AS workstatus,\n       '在職'                                                                              AS workstatusdesc,\n       log_operation.user_id                                                               AS grantuserid,\n       log_operation.user_name                                                             AS grantusername,\n       ''                                                                                  AS remark\nFROM   {{{settings.log_operation_table_name}}}                                             AS log_operation,\n       {{{settings.department_table_name}}}                                                AS department\nwhere  log_operation.category = 'permission'\nAND    log_operation.action_name != 'deleted'\nAND    cast(log_operation.create_time AS date) = dateadd(day, -1, cast(getdate() AS date))","modeOpt":"","modeOptType":"query","queryOpt":"","queryOptType":"editor","paramsOpt":"","paramsOptType":"editor","rows":"rows","rowsType":"msg","params":[],"x":760,"y":260,"wires":[["757deaaf.9e2304","1f45e8cf.8fe1f7"]]},{"id":"e5c8597d.a3c968","type":"http in","z":"deec9abb.8db008","name":"GET /action/sync/TS_SSOACInfo","url":"/action/sync/TS_SSOACInfo","method":"get","upload":false,"swaggerDoc":"","x":270,"y":260,"wires":[["8c7b6d8f.3dbb78"]]},{"id":"9b80a07e.24cb98","type":"inject","z":"deec9abb.8db008","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":310,"y":180,"wires":[["8c7b6d8f.3dbb78"]]},{"id":"757deaaf.9e2304","type":"debug","z":"deec9abb.8db008","name":"Display TS_SSOACInfo Result","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":1030,"y":220,"wires":[]},{"id":"1f45e8cf.8fe1f7","type":"http response","z":"deec9abb.8db008","name":"HTTP Response","statusCode":"","headers":{},"x":1000,"y":320,"wires":[]},{"id":"8c7b6d8f.3dbb78","type":"function","z":"deec9abb.8db008","name":"Apply Settings","func":"msg.settings = {}\n\nmsg.settings.log_operation_table_name = env.get(\"LOG_OPERATION_TABLE\") || \"[NBPKernel].[dbo].[log_operation]\"\nmsg.settings.department_table_name = env.get(\"DEPARTMENT_TABLE\") || \"[NBPKernel].[dbo].[department]\"\n\nmsg.settings.ts_ssoacinfo_table_name = env.get(\"TS_SSOACINFO_TABLE\") || \"[NBPReport].[dbo].[TS_SSOACInfo]\"\n\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":560,"y":260,"wires":[["74c0be11.330a1"]]},{"id":"ff98c474.486688","type":"http response","z":"deec9abb.8db008","name":"HTTP Response","statusCode":"","headers":{},"x":1180,"y":600,"wires":[]},{"id":"218a504e.5547f","type":"function","z":"deec9abb.8db008","name":"Check Result","func":"\nif ( (typeof msg.error == 'undefined') || (msg.error == null) )  {\n\n    msg.have_error = 0\n    msg.result = \"[GRAVITY][ATOMIC] Sync to TS_SSOACInfo Database Success\"\n\n    msg.payload = {\n        \"level\": \"INFO\",\n        \"code\": 0,\n        \"message\": msg.result,\n        \"channel\": \"GRAVITY_KERNEL_SINOPAC\",\n        \"timestamp\": (new Date()).toJSON() \n        \n    }\n    \n} \n\nelse {\n    msg.result = \"[GRAVITY][ATOMIC]Sync to TS_SSOACInfo Database Failure\"\n    msg.have_error = 1\n    \n    msg.payload = {\n        \"code\": 5304,\n        \"message\": msg.result,\n        \"channel\": \"GRAVITY_KERNEL_SINOPAC\",\n        \"level\": \"ERROR\",\n        \"timestamp\": (new Date()).toJSON(),\n        \"payload\": {\n            \"error\": msg.error\n        }\n    }\n}\n\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":980,"y":520,"wires":[["d645eeb2.59798","ff98c474.486688"]]},{"id":"d645eeb2.59798","type":"debug","z":"deec9abb.8db008","name":"Display TS_SSOACInfo Result","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":1230,"y":520,"wires":[]},{"id":"2feb0278.35a91e","type":"function","z":"deec9abb.8db008","name":"Apply Settings","func":"msg.settings = {}\n\nmsg.settings.log_operation_table_name = env.get(\"LOG_OPERATION_TABLE\") || \"[NBPKernel].[dbo].[log_operation]\"\nmsg.settings.department_table_name = env.get(\"DEPARTMENT_TABLE\") || \"[NBPKernel].[dbo].[department]\"\nmsg.settings.ts_ssoacinfo_table_name = env.get(\"TS_SSOACINFO_TABLE\") || \"[NBPReport].[dbo].[TS_SSOACInfo]\"\n\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":560,"y":520,"wires":[["cda26c39.d66a1"]]},{"id":"c65ef9ed.86209","type":"cronplus","z":"deec9abb.8db008","name":"Crontab","outputField":"payload","timeZone":"","persistDynamic":false,"commandResponseMsgOutput":"output1","outputs":1,"options":[{"name":"schedule1","topic":"topic1","payloadType":"default","payload":"","expressionType":"cron","expression":"0 10 5 * * * *","location":"","offset":"0","solarType":"all","solarEvents":"sunrise,sunset"}],"x":140,"y":660,"wires":[["2cada195.97cb3e"]]},{"id":"2cada195.97cb3e","type":"switch","z":"deec9abb.8db008","name":"Check Enabled","property":"SSOACINFO_SYNC_DAILY_ENABLED","propertyType":"env","rules":[{"t":"eq","v":"1","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":320,"y":660,"wires":[["2feb0278.35a91e"],[]]},{"id":"3da12305.eed754","type":"MSSQL","z":"4220a3b1.e65a7c","mssqlCN":"35b0806c.4ac0e8","name":"MSSQL Kernel","outField":"payload","returnType":0,"throwErrors":"0","query":"SELECT CONVERT(VARCHAR(8), log_operation.create_time, 112) AS APPDate,\n       'NBP'                                               AS APPID,\n       (\n              SELECT company.code\n              FROM   company\n              WHERE  log_operation.before_data IS NOT NULL\n              AND    Json_value(log_operation.before_data, '$.companyUid') = company.uid ) AS compid,\n       (\n              SELECT company.NAME\n              FROM   company\n              WHERE  log_operation.before_data IS NOT NULL\n              AND    Json_value(log_operation.before_data, '$.companyUid') = company.uid ) AS compname,\n       department.code                                                                     AS deptid,\n       department.NAME                                                                     AS deptname,\n       Json_value(before_data, '$.userId')                                                 AS empid,\n       Json_value(before_data, '$.name')                                                   AS empname,\n       log_operation.function_name                                                         AS funid,\n       ''                                                                                  AS funname,\n       '人工授權'                                                                          AS granttype,\n       log_operation.text                                                                  AS grantdesc,\n       1                                                                                   AS workstatus,\n       '在職'                                                                              AS workstatusdesc,\n       log_operation.user_id                                                               AS grantuserid,\n       log_operation.user_name                                                             AS grantusername,\n       ''                                                                                  AS remark\nFROM   {{{settings.log_operation_table_name}}}                                             AS log_operation,\n       {{{settings.department_table_name}}}                                                AS department\nwhere  log_operation.category = 'permission'\nAND    log_operation.action_name != 'deleted'\nAND    cast(log_operation.create_time AS date) = dateadd(day, -1, cast(getdate() AS date))","modeOpt":"","modeOptType":"query","queryOpt":"","queryOptType":"editor","paramsOpt":"","paramsOptType":"editor","rows":"rows","rowsType":"msg","params":[],"x":800,"y":420,"wires":[["30735e4a.e77f8a","faf5510d.a63c38"]]},{"id":"81c8c1e.26315c","type":"http in","z":"4220a3b1.e65a7c","name":"GET /action/sync/TS_SSOACInfo","url":"/action/sync/TS_SSOACInfo","method":"get","upload":false,"swaggerDoc":"","x":310,"y":420,"wires":[["f66d45d3.e1651"]]},{"id":"2a1e39df.3a2b76","type":"inject","z":"4220a3b1.e65a7c","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":350,"y":340,"wires":[["f66d45d3.e1651"]]},{"id":"30735e4a.e77f8a","type":"debug","z":"4220a3b1.e65a7c","name":"Display TS_SSOACInfo Result","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":1070,"y":380,"wires":[]},{"id":"faf5510d.a63c38","type":"http response","z":"4220a3b1.e65a7c","name":"HTTP Response","statusCode":"","headers":{},"x":1040,"y":480,"wires":[]},{"id":"f66d45d3.e1651","type":"function","z":"4220a3b1.e65a7c","name":"Apply Settings","func":"msg.settings = {}\n\nmsg.settings.log_operation_table_name = env.get(\"LOG_OPERATION_TABLE\") || \"[NBPKernel].[dbo].[log_operation]\"\nmsg.settings.department_table_name = env.get(\"DEPARTMENT_TABLE\") || \"[NBPKernel].[dbo].[department]\"\n\nmsg.settings.ts_ssoacinfo_table_name = env.get(\"TS_SSOACINFO_TABLE\") || \"[NBPReport].[dbo].[TS_SSOACInfo]\"\n\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":600,"y":420,"wires":[["3da12305.eed754"]]},{"id":"52c2548f.39026c","type":"MSSQL","z":"4220a3b1.e65a7c","mssqlCN":"1120185.4a64de8","name":"MSSQL Kernel","outField":"payload","returnType":0,"throwErrors":"0","query":"INSERT INTO\n\nSELECT CONVERT(VARCHAR(8), log_operation.create_time, 112) AS AppDate,\n       'NBP'                                       AS AppID,\n       (SELECT company.code\n        FROM   company\n        WHERE  log_operation.before_data IS NOT NULL\n               AND Json_value(log_operation.before_data, '$.companyUid') =\n                   company.uid)\n                                                   AS CompID,\n       (SELECT company.NAME\n        FROM   company\n        WHERE  log_operation.before_data IS NOT NULL\n               AND Json_value(log_operation.before_data, '$.companyUid') =\n                   company.uid)\n                                                   AS CompName,\n       department.code                             AS DeptID,\n       department.NAME                             AS DeptName,\n       Json_value(before_data, '$.userId')         AS EmpID,\n       Json_value(before_data, '$.name')           AS EmpName,\n       log_operation.function_name                 AS FunID,\n       ''                                          AS FunName,\n       '人工授權'                              AS GrantType,\n       log_operation.text                          AS GrantDesc,\n       1                                           AS WorkStatus,\n       '在職'                                    AS WorkStatusDesc,\n       log_operation.user_id                       AS GrantUserID,\n       log_operation.user_name                     GrantUserName,\n       ''                                          AS Remark\nFROM   log_operation,\n       department\nWHERE  category = 'permission' \n       AND action_name != 'deleted'\n       AND CAST(send_record.create_time AS date) = DATEADD(day, -1, CAST(GETDATE() AS date))\n","modeOpt":"","modeOptType":"query","queryOpt":"","queryOptType":"editor","paramsOpt":"","paramsOptType":"editor","rows":"rows","rowsType":"msg","params":[],"x":800,"y":700,"wires":[["cc32edec.c0b9a"]]},{"id":"39e7cd89.1271b2","type":"http in","z":"4220a3b1.e65a7c","name":"POST /action/sync/TS_SSOACInfo","url":"/action/sync/TS_SSOACInfo","method":"post","upload":false,"swaggerDoc":"","x":320,"y":700,"wires":[["87a73095.4146f"]]},{"id":"ae7bfb7d.ebcaa","type":"inject","z":"4220a3b1.e65a7c","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":370,"y":620,"wires":[["87a73095.4146f"]]},{"id":"b836814b.f5d31","type":"http response","z":"4220a3b1.e65a7c","name":"HTTP Response","statusCode":"","headers":{},"x":1220,"y":780,"wires":[]},{"id":"cc32edec.c0b9a","type":"function","z":"4220a3b1.e65a7c","name":"Check Result","func":"\nif ( (typeof msg.error == 'undefined') || (msg.error == null) )  {\n\n    msg.have_error = 0\n    msg.result = \"[GRAVITY][ATOMIC] Sync to TS_SSOACInfo Database Success\"\n\n    msg.payload = {\n        \"level\": \"INFO\",\n        \"code\": 0,\n        \"message\": msg.result,\n        \"channel\": \"GRAVITY_KERNEL_SINOPAC\",\n        \"timestamp\": (new Date()).toJSON() \n        \n    }\n    \n} \n\nelse {\n    msg.result = \"[GRAVITY][ATOMIC]Sync to TS_SSOACInfo Database Failure\"\n    msg.have_error = 1\n    \n    msg.payload = {\n        \"code\": 5304,\n        \"message\": msg.result,\n        \"channel\": \"GRAVITY_KERNEL_SINOPAC\",\n        \"level\": \"ERROR\",\n        \"timestamp\": (new Date()).toJSON(),\n        \"payload\": {\n            \"error\": msg.error\n        }\n    }\n}\n\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1020,"y":700,"wires":[["4e7acead.e4dfe8","b836814b.f5d31"]]},{"id":"4e7acead.e4dfe8","type":"debug","z":"4220a3b1.e65a7c","name":"Display TS_SSOACInfo Result","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":1270,"y":700,"wires":[]},{"id":"87a73095.4146f","type":"function","z":"4220a3b1.e65a7c","name":"Apply Settings","func":"msg.settings = {}\n\nmsg.settings.log_operation_table_name = env.get(\"LOG_OPERATION_TABLE\") || \"[NBPKernel].[dbo].[log_operation]\"\nmsg.settings.department_table_name = env.get(\"DEPARTMENT_TABLE\") || \"[NBPKernel].[dbo].[department]\"\nmsg.settings.ts_ssoacinfo_table_name = env.get(\"TS_SSOACINFO_TABLE\") || \"[NBPReport].[dbo].[TS_SSOACInfo]\"\n\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":600,"y":700,"wires":[["52c2548f.39026c"]]},{"id":"a4daf9b7.aaae2","type":"cronplus","z":"4220a3b1.e65a7c","name":"Crontab","outputField":"payload","timeZone":"","persistDynamic":false,"commandResponseMsgOutput":"output1","outputs":1,"options":[{"name":"schedule1","topic":"topic1","payloadType":"default","payload":"","expressionType":"cron","expression":"0 10 5 * * * *","location":"","offset":"0","solarType":"all","solarEvents":"sunrise,sunset"}],"x":180,"y":840,"wires":[["2b48e235.e8d426"]]},{"id":"2b48e235.e8d426","type":"switch","z":"4220a3b1.e65a7c","name":"Check Enabled","property":"SSOACINFO_SYNC_DAILY_ENABLED","propertyType":"env","rules":[{"t":"eq","v":"1","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":360,"y":840,"wires":[["87a73095.4146f"],[]]}]